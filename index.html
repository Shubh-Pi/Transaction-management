<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Multi-Person Transaction Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Link to the external CSS file -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay hidden">
    <div class="spinner"></div>
  </div>

  <!-- Fixed Header -->
  <header class="fixed-header">
    <h1>Transaction Manager</h1>
  </header>

  <div class="container">
    <!-- Summary (Excel-like) View -->
    <section id="summary-view">
      <div class="action-bar">
        <input type="text" id="search-bar" placeholder="Search by name...">
        <button id="refresh-btn" class="refresh-btn" title="Refresh data">üîÑ Refresh</button>
      </div>
      <form id="add-person-form">
        <input type="text" id="new-person-name" placeholder="Enter new person's name" required>
        <button type="submit">Add Person</button>
      </form>
      <table id="summary-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Balance ($)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Persons will be listed here -->
        </tbody>
      </table>
    </section>

    <!-- Transaction Detail View -->
    <section id="transaction-view" class="hidden">
      <button id="back-to-summary" class="back-btn">‚Üê Back to Summary</button>
      <header>
        <h1 id="person-heading">Transactions for: </h1>
      </header>
      <h2>Current Balance: $<span id="balance">0.00</span></h2>
      <form id="transaction-form">
        <select id="transaction-type">
          <option value="payment">Payment to Shop Owner</option>
          <option value="received">Received Payment</option>
        </select>
        <input type="number" id="amount" placeholder="Amount" required step="0.01">
        <input type="text" id="description" placeholder="Description">
        <button type="submit">Add Transaction</button>
      </form>
      <div id="transaction-list">
        <!-- Detailed transactions will be listed here -->
      </div>
    </section>
  </div>

  <script>
    // Set your Worker subdomain URL
    const workerURL = "https://transaction-manager-worker.balgudeshubham64.workers.dev";

    // Loading overlay helper
    const loadingOverlay = document.getElementById('loading-overlay');
    function showLoading() {
      loadingOverlay.classList.remove('hidden');
    }
    function hideLoading() {
      loadingOverlay.classList.add('hidden');
    }

    // API Endpoints using the Worker subdomain with error handling
    async function fetchPersons() {
      try {
        console.log('Fetching persons from KV...');
        const res = await fetch(`${workerURL}/api/persons`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        console.log('Persons fetched:', data);
        return data;
      } catch (error) {
        console.error('Error fetching persons:', error);
        alert('Failed to load persons. Please try again.');
        return [];
      }
    }
    async function addPerson(person) {
      try {
        console.log('Adding person to KV:', person);
        const res = await fetch(`${workerURL}/api/persons`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(person)
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        console.log('Person added:', data);
        return data;
      } catch (error) {
        console.error('Error adding person:', error);
        alert('Failed to add person. Please try again.');
        throw error;
      }
    }
    async function deletePerson(personId) {
      try {
        console.log('Deleting person from KV:', personId);
        const res = await fetch(`${workerURL}/api/persons/${personId}`, {
          method: 'DELETE'
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        console.log('Person deleted:', data);
        return data;
      } catch (error) {
        console.error('Error deleting person:', error);
        alert('Failed to delete person. Please try again.');
        throw error;
      }
    }
    async function fetchTransactions() {
      try {
        console.log('Fetching transactions from KV...');
        const res = await fetch(`${workerURL}/api/transactions`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        console.log('Transactions fetched:', data);
        return data;
      } catch (error) {
        console.error('Error fetching transactions:', error);
        alert('Failed to load transactions. Please try again.');
        return [];
      }
    }
    async function addTransaction(tx) {
      try {
        console.log('Adding transaction to KV:', tx);
        const res = await fetch(`${workerURL}/api/transactions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(tx)
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        console.log('Transaction added:', data);
        return data;
      } catch (error) {
        console.error('Error adding transaction:', error);
        alert('Failed to add transaction. Please try again.');
        throw error;
      }
    }
    async function updateTransaction(txId, data) {
      try {
        console.log('Updating transaction in KV:', txId, data);
        const res = await fetch(`${workerURL}/api/transactions/${txId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const result = await res.json();
        console.log('Transaction updated:', result);
        return result;
      } catch (error) {
        console.error('Error updating transaction:', error);
        alert('Failed to update transaction. Please try again.');
        throw error;
      }
    }
    async function deleteTransactionAPI(txId) {
      try {
        console.log('Deleting transaction from KV:', txId);
        const res = await fetch(`${workerURL}/api/transactions/${txId}`, {
          method: 'DELETE'
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        console.log('Transaction deleted:', data);
        return data;
      } catch (error) {
        console.error('Error deleting transaction:', error);
        alert('Failed to delete transaction. Please try again.');
        throw error;
      }
    }

    // Global state
    let persons = [];
    let transactions = [];
    let currentPerson = null;

    // DOM Elements
    const summaryView = document.getElementById('summary-view');
    const transactionView = document.getElementById('transaction-view');
    const summaryTableBody = document.getElementById('summary-table').querySelector('tbody');
    const addPersonForm = document.getElementById('add-person-form');
    const newPersonNameEl = document.getElementById('new-person-name');
    const searchBar = document.getElementById('search-bar');
    const refreshBtn = document.getElementById('refresh-btn');
    const backBtn = document.getElementById('back-to-summary');
    const personHeading = document.getElementById('person-heading');
    const balanceEl = document.getElementById('balance');
    const transactionListEl = document.getElementById('transaction-list');
    const transactionForm = document.getElementById('transaction-form');
    const transactionTypeEl = document.getElementById('transaction-type');
    const amountEl = document.getElementById('amount');
    const descriptionEl = document.getElementById('description');

    async function loadData() {
      showLoading();
      persons = await fetchPersons();
      transactions = await fetchTransactions();
      renderSummary();
      hideLoading();
    }

    // Render the summary table with search filtering and delete buttons
    function renderSummary() {
      summaryTableBody.innerHTML = '';
      const searchQuery = searchBar.value.toLowerCase();
      const filteredPersons = persons.filter(p => p.name.toLowerCase().includes(searchQuery));
      if (filteredPersons.length === 0) {
        summaryTableBody.innerHTML = "<tr><td colspan='3'>No persons found.</td></tr>";
        return;
      }
      filteredPersons.forEach(person => {
        const balance = calculateBalanceForPerson(person.id);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${person.name}</td>
          <td>${balance.toFixed(2)}</td>
          <td>
            <button onclick="openTransactionView('${person.id}')">View Transactions</button>
            <button onclick="handleDeletePerson('${person.id}')">Delete</button>
          </td>
        `;
        summaryTableBody.appendChild(row);
      });
    }

    // Calculate a person's balance
    function calculateBalanceForPerson(personId) {
      const personTransactions = transactions.filter(tx => tx.personId === personId);
      let balance = 0;
      personTransactions.forEach(tx => {
        if (tx.type === 'payment') {
          balance -= Number(tx.amount);
        } else if (tx.type === 'received') {
          balance += Number(tx.amount);
        }
      });
      return balance;
    }

    // Open the transaction view for a specific person
    async function openTransactionView(personId) {
      currentPerson = persons.find(p => p.id === personId);
      personHeading.textContent = `Transactions for: ${currentPerson.name}`;
      summaryView.classList.add('hidden');
      transactionView.classList.remove('hidden');
      renderTransactions();
    }
    window.openTransactionView = openTransactionView;

    backBtn.addEventListener('click', async () => {
      currentPerson = null;
      transactionView.classList.add('hidden');
      summaryView.classList.remove('hidden');
      await loadData();
    });

    refreshBtn.addEventListener('click', async () => {
      await loadData();
    });

    addPersonForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = newPersonNameEl.value.trim();
      if (!name) return;
      showLoading();
      try {
        const newPerson = { id: Date.now().toString(), name };
        await addPerson(newPerson);
        newPersonNameEl.value = '';
        await loadData();
      } catch (error) {
        console.error('Failed to add person:', error);
      }
      hideLoading();
    });

    // Delete person function
    async function handleDeletePerson(personId) {
      if (confirm("Are you sure you want to delete this person?")) {
        showLoading();
        try {
          await deletePerson(personId);
          await loadData();
        } catch (error) {
          console.error('Failed to delete person:', error);
        }
        hideLoading();
      }
    }
    window.handleDeletePerson = handleDeletePerson;

    transactionForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentPerson) return;
      const type = transactionTypeEl.value;
      const amount = amountEl.value;
      const description = descriptionEl.value;
      if (!amount) return;
      showLoading();
      try {
        const tx = {
          id: Date.now().toString(),
          personId: currentPerson.id,
          type,
          amount,
          description,
          date: new Date().toISOString()
        };
        await addTransaction(tx);
        transactionForm.reset();
        transactions = await fetchTransactions();
        renderTransactions();
      } catch (error) {
        console.error('Failed to add transaction:', error);
      }
      hideLoading();
    });

    // Delete transaction function
    async function deleteTransaction(e) {
      const txId = e.target.getAttribute('data-id');
      showLoading();
      try {
        await deleteTransactionAPI(txId);
        transactions = await fetchTransactions();
        renderTransactions();
      } catch (error) {
        console.error('Failed to delete transaction:', error);
      }
      hideLoading();
    }
    window.deleteTransaction = deleteTransaction;


    function renderTransactions() {
      transactionListEl.innerHTML = '';
      const personTransactions = transactions.filter(tx => tx.personId === currentPerson.id);
      // Sort transactions (newest first)
      personTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
      personTransactions.forEach(tx => {
        const txDiv = document.createElement('div');
        txDiv.classList.add('transaction');
        const txTypeLabel = tx.type === 'payment' ? 'Payment to Shop Owner' : 'Received Payment';
        txDiv.innerHTML = `
          <div class="details">
            <strong>${txTypeLabel}</strong>: $${Number(tx.amount).toFixed(2)}<br>
            <small>${tx.description || ''}</small><br>
            <small>${new Date(tx.date).toLocaleString()}</small>
          </div>
          <button data-id="${tx.id}" onclick="deleteTransaction(event)">Delete</button>
        `;
        transactionListEl.appendChild(txDiv);
      });
      balanceEl.textContent = calculateBalanceForPerson(currentPerson.id).toFixed(2);
    }

    searchBar.addEventListener('input', () => {
      renderSummary();
    });

    // Initial load from Cloudflare Worker
    loadData();
  </script>
</body>
</html>
