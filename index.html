<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Transaction Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Toast Notification Container -->
  <div id="toast-container"></div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay hidden">
    <div class="spinner"></div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmation-modal" class="modal hidden">
    <div class="modal-content">
      <h3 id="modal-title">Confirm Action</h3>
      <p id="modal-message">Are you sure?</p>
      <div class="modal-actions">
        <button id="modal-cancel" class="btn btn-secondary">Cancel</button>
        <button id="modal-confirm" class="btn btn-danger">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Fixed Header -->
  <header class="fixed-header">
    <div class="header-content">
      <h1>Transaction Manager</h1>
      <button id="dark-mode-toggle" class="icon-btn" title="Toggle Dark Mode">
        <span class="icon">üåô</span>
      </button>
    </div>
  </header>

  <div class="container">
    <!-- Analytics Dashboard -->
    <section id="analytics-view" class="analytics-dashboard">
      <div class="analytics-grid">
        <div class="analytics-card">
          <div class="analytics-icon">üë•</div>
          <div class="analytics-info">
            <div class="analytics-value" id="total-persons">0</div>
            <div class="analytics-label">Total Persons</div>
          </div>
        </div>
        <div class="analytics-card">
          <div class="analytics-icon">üí∞</div>
          <div class="analytics-info">
            <div class="analytics-value" id="total-transactions">0</div>
            <div class="analytics-label">Total Transactions</div>
          </div>
        </div>
        <div class="analytics-card">
          <div class="analytics-icon">üìà</div>
          <div class="analytics-info">
            <div class="analytics-value" id="total-received">$0.00</div>
            <div class="analytics-label">Total Received</div>
          </div>
        </div>
        <div class="analytics-card">
          <div class="analytics-icon">üìâ</div>
          <div class="analytics-info">
            <div class="analytics-value" id="total-paid">$0.00</div>
            <div class="analytics-label">Total Paid</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Summary View -->
    <section id="summary-view">
      <div class="section-header">
        <h2>People & Balances</h2>
        <div class="action-buttons">
          <button id="refresh-btn" class="btn btn-success" title="Refresh data">
            <span class="icon">üîÑ</span> Refresh
          </button>
        </div>
      </div>

      <div class="search-filter-bar">
        <input type="text" id="search-bar" class="search-input" placeholder="üîç Search by name...">
      </div>

      <form id="add-person-form" class="card form-card">
        <h3>Add New Person</h3>
        <div class="form-group">
          <input type="text" id="new-person-name" class="form-input" placeholder="Enter person's name" required>
          <button type="submit" class="btn btn-primary">Add Person</button>
        </div>
        <div class="form-error" id="add-person-error"></div>
      </form>

      <div class="persons-grid" id="persons-grid">
        <!-- Person cards will be inserted here -->
      </div>
    </section>

    <!-- Transaction Detail View -->
    <section id="transaction-view" class="hidden">
      <button id="back-to-summary" class="btn btn-secondary back-btn">
        <span class="icon">‚Üê</span> Back to Summary
      </button>

      <div class="transaction-header">
        <h2 id="person-heading">Transactions</h2>
        <h3 class="balance-display">Balance: <span id="balance" class="balance-amount">$0.00</span></h3>
      </div>

      <form id="transaction-form" class="card form-card">
        <h3>Add Transaction</h3>
        <div class="form-grid">
          <select id="transaction-type" class="form-input" required>
            <option value="">Select Type</option>
            <option value="payment">Payment to Shop Owner</option>
            <option value="received">Received Payment</option>
          </select>
          <input type="number" id="amount" class="form-input" placeholder="Amount ($)" required step="0.01" min="0.01">
          <input type="text" id="description" class="form-input" placeholder="Description (optional)">
          <button type="submit" class="btn btn-primary">Add Transaction</button>
        </div>
        <div class="form-error" id="add-transaction-error"></div>
      </form>

      <div class="transaction-controls">
        <div class="sort-controls">
          <label>Sort by:</label>
          <select id="sort-by" class="form-input compact">
            <option value="date-desc">Date (Newest First)</option>
            <option value="date-asc">Date (Oldest First)</option>
            <option value="amount-desc">Amount (High to Low)</option>
            <option value="amount-asc">Amount (Low to High)</option>
          </select>
        </div>
        <button id="export-csv-btn" class="btn btn-success">
          <span class="icon">üì•</span> Export CSV
        </button>
      </div>

      <div id="transaction-list" class="transactions-container">
        <!-- Transactions will be inserted here -->
      </div>
    </section>
  </div>

  <script>
    const workerURL = "https://transaction-manager-worker.balgudeshubham64.workers.dev";

    // State Management
    let persons = [];
    let transactions = [];
    let currentPerson = null;
    let currentSortBy = 'date-desc';

    // DOM Elements
    const loadingOverlay = document.getElementById('loading-overlay');
    const toastContainer = document.getElementById('toast-container');
    const confirmationModal = document.getElementById('confirmation-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalCancel = document.getElementById('modal-cancel');
    const modalConfirm = document.getElementById('modal-confirm');
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const summaryView = document.getElementById('summary-view');
    const transactionView = document.getElementById('transaction-view');
    const personsGrid = document.getElementById('persons-grid');
    const addPersonForm = document.getElementById('add-person-form');
    const newPersonNameEl = document.getElementById('new-person-name');
    const addPersonError = document.getElementById('add-person-error');
    const searchBar = document.getElementById('search-bar');
    const refreshBtn = document.getElementById('refresh-btn');
    const backBtn = document.getElementById('back-to-summary');
    const personHeading = document.getElementById('person-heading');
    const balanceEl = document.getElementById('balance');
    const transactionListEl = document.getElementById('transaction-list');
    const transactionForm = document.getElementById('transaction-form');
    const transactionTypeEl = document.getElementById('transaction-type');
    const amountEl = document.getElementById('amount');
    const descriptionEl = document.getElementById('description');
    const addTransactionError = document.getElementById('add-transaction-error');
    const sortByEl = document.getElementById('sort-by');
    const exportCsvBtn = document.getElementById('export-csv-btn');

    // Analytics Elements
    const totalPersonsEl = document.getElementById('total-persons');
    const totalTransactionsEl = document.getElementById('total-transactions');
    const totalReceivedEl = document.getElementById('total-received');
    const totalPaidEl = document.getElementById('total-paid');

    // Utility Functions
    function showLoading() {
      loadingOverlay.classList.remove('hidden');
    }

    function hideLoading() {
      loadingOverlay.classList.add('hidden');
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      toastContainer.appendChild(toast);

      setTimeout(() => toast.classList.add('show'), 10);

      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function showConfirmModal(title, message) {
      return new Promise((resolve) => {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        confirmationModal.classList.remove('hidden');

        const handleConfirm = () => {
          confirmationModal.classList.add('hidden');
          modalConfirm.removeEventListener('click', handleConfirm);
          modalCancel.removeEventListener('click', handleCancel);
          resolve(true);
        };

        const handleCancel = () => {
          confirmationModal.classList.add('hidden');
          modalConfirm.removeEventListener('click', handleConfirm);
          modalCancel.removeEventListener('click', handleCancel);
          resolve(false);
        };

        modalConfirm.addEventListener('click', handleConfirm);
        modalCancel.addEventListener('click', handleCancel);
      });
    }

    // Dark Mode
    function initDarkMode() {
      const isDark = localStorage.getItem('darkMode') === 'true';
      if (isDark) {
        document.body.classList.add('dark-mode');
        darkModeToggle.querySelector('.icon').textContent = '‚òÄÔ∏è';
      }
    }

    darkModeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDark);
      darkModeToggle.querySelector('.icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      showToast(`Dark mode ${isDark ? 'enabled' : 'disabled'}`, 'success');
    });

    // API Functions with Error Handling
    async function fetchPersons() {
      try {
        console.log('Fetching persons from KV...');
        const res = await fetch(`${workerURL}/api/persons`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        console.log('Persons fetched:', data);
        return data;
      } catch (error) {
        console.error('Error fetching persons:', error);
        showToast('Failed to load persons', 'error');
        return [];
      }
    }

    async function addPerson(person) {
      try {
        console.log('Adding person to KV:', person);
        const res = await fetch(`${workerURL}/api/persons`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(person)
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        console.log('Person added:', data);
        return data;
      } catch (error) {
        console.error('Error adding person:', error);
        throw error;
      }
    }

    async function deletePerson(personId) {
      try {
        console.log('Deleting person from KV:', personId);
        const res = await fetch(`${workerURL}/api/persons/${personId}`, {
          method: 'DELETE'
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        console.log('Person deleted:', data);
        return data;
      } catch (error) {
        console.error('Error deleting person:', error);
        throw error;
      }
    }

    async function fetchTransactions() {
      try {
        console.log('Fetching transactions from KV...');
        const res = await fetch(`${workerURL}/api/transactions`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        console.log('Transactions fetched:', data);
        return data;
      } catch (error) {
        console.error('Error fetching transactions:', error);
        showToast('Failed to load transactions', 'error');
        return [];
      }
    }

    async function addTransaction(tx) {
      try {
        console.log('Adding transaction to KV:', tx);
        const res = await fetch(`${workerURL}/api/transactions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(tx)
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        console.log('Transaction added:', data);
        return data;
      } catch (error) {
        console.error('Error adding transaction:', error);
        throw error;
      }
    }

    async function deleteTransactionAPI(txId) {
      try {
        console.log('Deleting transaction from KV:', txId);
        const res = await fetch(`${workerURL}/api/transactions/${txId}`, {
          method: 'DELETE'
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        console.log('Transaction deleted:', data);
        return data;
      } catch (error) {
        console.error('Error deleting transaction:', error);
        throw error;
      }
    }

    // Data Loading
    async function loadData() {
      showLoading();
      persons = await fetchPersons();
      transactions = await fetchTransactions();
      renderAnalytics();
      renderPersons();
      hideLoading();
    }

    // Analytics Rendering
    function renderAnalytics() {
      totalPersonsEl.textContent = persons.length;
      totalTransactionsEl.textContent = transactions.length;

      let totalReceived = 0;
      let totalPaid = 0;

      transactions.forEach(tx => {
        const amount = Number(tx.amount);
        if (tx.type === 'received') {
          totalReceived += amount;
        } else if (tx.type === 'payment') {
          totalPaid += amount;
        }
      });

      totalReceivedEl.textContent = `$${totalReceived.toFixed(2)}`;
      totalPaidEl.textContent = `$${totalPaid.toFixed(2)}`;
    }

    // Balance Calculation
    function calculateBalanceForPerson(personId) {
      const personTransactions = transactions.filter(tx => tx.personId === personId);
      let balance = 0;
      personTransactions.forEach(tx => {
        if (tx.type === 'payment') {
          balance -= Number(tx.amount);
        } else if (tx.type === 'received') {
          balance += Number(tx.amount);
        }
      });
      return balance;
    }

    // Person Rendering
    function renderPersons() {
      personsGrid.innerHTML = '';
      const searchQuery = searchBar.value.toLowerCase();
      const filteredPersons = persons.filter(p => p.name.toLowerCase().includes(searchQuery));

      if (filteredPersons.length === 0) {
        personsGrid.innerHTML = '<div class="empty-state">No persons found.</div>';
        return;
      }

      filteredPersons.forEach(person => {
        const balance = calculateBalanceForPerson(person.id);
        const balanceClass = balance >= 0 ? 'positive' : 'negative';

        const card = document.createElement('div');
        card.className = 'person-card card';
        card.innerHTML = `
          <div class="person-info">
            <h3 class="person-name">${person.name}</h3>
            <div class="person-balance ${balanceClass}">$${balance.toFixed(2)}</div>
          </div>
          <div class="person-actions">
            <button onclick="openTransactionView('${person.id}')" class="btn btn-primary btn-sm">
              View Transactions
            </button>
            <button onclick="handleDeletePerson('${person.id}')" class="btn btn-danger btn-sm">
              Delete
            </button>
          </div>
        `;
        personsGrid.appendChild(card);
      });
    }

    // Transaction View
    async function openTransactionView(personId) {
      currentPerson = persons.find(p => p.id === personId);
      personHeading.textContent = `Transactions for: ${currentPerson.name}`;
      summaryView.classList.add('hidden');
      transactionView.classList.remove('hidden');
      renderTransactions();
    }
    window.openTransactionView = openTransactionView;

    // Transaction Sorting
    function sortTransactions(txList) {
      const sorted = [...txList];

      switch(currentSortBy) {
        case 'date-desc':
          sorted.sort((a, b) => new Date(b.date) - new Date(a.date));
          break;
        case 'date-asc':
          sorted.sort((a, b) => new Date(a.date) - new Date(b.date));
          break;
        case 'amount-desc':
          sorted.sort((a, b) => Number(b.amount) - Number(a.amount));
          break;
        case 'amount-asc':
          sorted.sort((a, b) => Number(a.amount) - Number(b.amount));
          break;
      }

      return sorted;
    }

    // Transaction Rendering
    function renderTransactions() {
      transactionListEl.innerHTML = '';
      const personTransactions = transactions.filter(tx => tx.personId === currentPerson.id);
      const sortedTransactions = sortTransactions(personTransactions);

      if (sortedTransactions.length === 0) {
        transactionListEl.innerHTML = '<div class="empty-state">No transactions yet.</div>';
        balanceEl.textContent = '$0.00';
        return;
      }

      sortedTransactions.forEach(tx => {
        const txDiv = document.createElement('div');
        txDiv.className = `transaction-card card ${tx.type}`;
        const txTypeLabel = tx.type === 'payment' ? 'Payment to Shop Owner' : 'Received Payment';
        const txIcon = tx.type === 'payment' ? 'üí≥' : 'üí∞';

        txDiv.innerHTML = `
          <div class="transaction-icon">${txIcon}</div>
          <div class="transaction-details">
            <div class="transaction-type">${txTypeLabel}</div>
            <div class="transaction-amount ${tx.type}">$${Number(tx.amount).toFixed(2)}</div>
            ${tx.description ? `<div class="transaction-description">${tx.description}</div>` : ''}
            <div class="transaction-date">${new Date(tx.date).toLocaleString()}</div>
          </div>
          <button data-id="${tx.id}" onclick="deleteTransaction(event)" class="btn btn-danger btn-sm">
            Delete
          </button>
        `;
        transactionListEl.appendChild(txDiv);
      });

      const balance = calculateBalanceForPerson(currentPerson.id);
      balanceEl.textContent = `$${balance.toFixed(2)}`;
      balanceEl.className = `balance-amount ${balance >= 0 ? 'positive' : 'negative'}`;
    }

    // CSV Export
    function exportToCSV() {
      if (!currentPerson) return;

      const personTransactions = transactions.filter(tx => tx.personId === currentPerson.id);

      if (personTransactions.length === 0) {
        showToast('No transactions to export', 'warning');
        return;
      }

      let csv = 'Date,Type,Amount,Description\n';
      personTransactions.forEach(tx => {
        const date = new Date(tx.date).toLocaleString();
        const type = tx.type === 'payment' ? 'Payment' : 'Received';
        const amount = Number(tx.amount).toFixed(2);
        const desc = (tx.description || '').replace(/,/g, ';');
        csv += `"${date}","${type}","${amount}","${desc}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentPerson.name}_transactions.csv`;
      a.click();
      window.URL.revokeObjectURL(url);

      showToast('CSV exported successfully', 'success');
    }

    // Event Handlers
    backBtn.addEventListener('click', async () => {
      currentPerson = null;
      transactionView.classList.add('hidden');
      summaryView.classList.remove('hidden');
      await loadData();
    });

    refreshBtn.addEventListener('click', async () => {
      await loadData();
      showToast('Data refreshed', 'success');
    });

    searchBar.addEventListener('input', () => {
      renderPersons();
    });

    sortByEl.addEventListener('change', () => {
      currentSortBy = sortByEl.value;
      renderTransactions();
    });

    exportCsvBtn.addEventListener('click', exportToCSV);

    // Add Person Form
    addPersonForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      addPersonError.textContent = '';

      const name = newPersonNameEl.value.trim();

      if (!name) {
        addPersonError.textContent = 'Please enter a name';
        return;
      }

      if (name.length < 2) {
        addPersonError.textContent = 'Name must be at least 2 characters';
        return;
      }

      showLoading();
      try {
        const newPerson = { id: Date.now().toString(), name };
        await addPerson(newPerson);
        newPersonNameEl.value = '';
        await loadData();
        showToast('Person added successfully', 'success');
      } catch (error) {
        addPersonError.textContent = 'Failed to add person. Please try again.';
        showToast('Failed to add person', 'error');
      }
      hideLoading();
    });

    // Delete Person
    async function handleDeletePerson(personId) {
      const person = persons.find(p => p.id === personId);
      const confirmed = await showConfirmModal(
        'Delete Person',
        `Are you sure you want to delete ${person.name}? All their transactions will also be deleted.`
      );

      if (!confirmed) return;

      showLoading();
      try {
        await deletePerson(personId);
        await loadData();
        showToast('Person deleted successfully', 'success');
      } catch (error) {
        showToast('Failed to delete person', 'error');
      }
      hideLoading();
    }
    window.handleDeletePerson = handleDeletePerson;

    // Add Transaction Form
    transactionForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      addTransactionError.textContent = '';

      if (!currentPerson) return;

      const type = transactionTypeEl.value;
      const amount = amountEl.value;
      const description = descriptionEl.value.trim();

      if (!type) {
        addTransactionError.textContent = 'Please select a transaction type';
        return;
      }

      if (!amount || amount <= 0) {
        addTransactionError.textContent = 'Please enter a valid amount';
        return;
      }

      showLoading();
      try {
        const tx = {
          id: Date.now().toString(),
          personId: currentPerson.id,
          type,
          amount,
          description,
          date: new Date().toISOString()
        };
        await addTransaction(tx);
        transactionForm.reset();
        transactions = await fetchTransactions();
        renderTransactions();
        renderAnalytics();
        showToast('Transaction added successfully', 'success');
      } catch (error) {
        addTransactionError.textContent = 'Failed to add transaction. Please try again.';
        showToast('Failed to add transaction', 'error');
      }
      hideLoading();
    });

    // Delete Transaction
    async function deleteTransaction(e) {
      const txId = e.target.getAttribute('data-id');

      const confirmed = await showConfirmModal(
        'Delete Transaction',
        'Are you sure you want to delete this transaction?'
      );

      if (!confirmed) return;

      showLoading();
      try {
        await deleteTransactionAPI(txId);
        transactions = await fetchTransactions();
        renderTransactions();
        renderAnalytics();
        showToast('Transaction deleted successfully', 'success');
      } catch (error) {
        showToast('Failed to delete transaction', 'error');
      }
      hideLoading();
    }
    window.deleteTransaction = deleteTransaction;

    // Initialize
    initDarkMode();
    loadData();
  </script>
</body>
</html>
